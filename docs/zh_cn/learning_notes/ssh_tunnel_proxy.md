# OpenAI API 访问问题排查文档

## 临时性解决方案

评测 API 模型不需要云端服务器的计算资源，所以我们直接本地运行评测脚本。

## 思考：云平台的网络访问限制

在排查过程中，我们发现了一个值得深思的问题：为什么国内云平台对 VPN 访问有如此严格的限制？这种限制可能会影响平台的实用性。

### 1. 开发者需求分析

在当今的开发环境中，访问国际网络资源几乎是必需的：
- GitHub、Stack Overflow 等基础开发资源
- OpenAI API、HuggingFace 等 AI 服务
- Google Scholar、arXiv 等学术资源
- npm、pip 等包管理工具的国际源

### 2. 现实困境

目前的情况导致了一个悖论：
- 云平台的目标是提供便利的开发环境
- 但网络限制却妨碍了开发者使用必要的工具和服务
- 这可能导致开发者选择其他解决方案，如：
  * 使用国际云服务商
  * 在本地完成所有开发工作
  * 寻找替代服务

### 3. 可能的解决方向

对于云平台提供商：
- 提供官方的、合规的代理服务
- 为企业用户开放特定的网络访问权限
- 建立国内镜像源生态系统

对于开发者：
- 合理划分本地开发和云端部署的边界
- 使用平台认可的代理服务
- 建立完整的本地开发环境

## 需求描述

在使用 OpenCompass 评测 OpenAI API 时，我们遇到了以下场景：

1. 本地环境：
   - Mac 电脑
   - 安装了 VPN 客户端（如 LetsVPN）
   - 可以正常访问 OpenAI API

2. 远程环境：
   - 云服务器（容器环境）
   - 无法直接访问 OpenAI API
   - 可以通过 SSH 连接（端口 44773）

3. 目标：
   - 让远程服务器能够使用本地的 VPN 访问 OpenAI API
   - 不影响服务器的其他网络连接
   - 操作尽量简单可靠

## 尝试过的方案

1. SSH 本地端口转发 (-L)：
```bash
ssh -L 7901:127.0.0.1:7890 -p 44773 root@ssh.intern-ai.org.cn
```

2. SSH 远程端口转发 (-R)：
```bash
ssh -R '*:7901:127.0.0.1:7890' -p 44773 root@ssh.intern-ai.org.cn
```

3. SSH 动态端口转发 (-D)：
```bash
ssh -D 7901 -p 44773 root@ssh.intern-ai.org.cn -N
```

## 问题排查过程

### 1. 初步诊断

尝试建立 SSH 隧道后，进行了一系列测试：

1. 本地 VPN 状态验证：
```bash
# 本地直接访问 Google
curl www.google.com
# 结果：成功获得 302 重定向响应，说明本地 VPN 正常工作
```

2. SSH 隧道连接测试：
```bash
# 使用 -v 参数查看详细连接信息
ssh -v -N -D 0.0.0.0:7901 -p 44773 root@ssh.intern-ai.org.cn
# 结果：SSH 连接成功建立，端口转发正��启动
```

3. 本地端口监听确认：
```bash
netstat -an | grep LISTEN | grep 7901
# 结果：确认端口正在监听
# tcp4  0  0  *.7901    *.*    LISTEN
# tcp4  0  0  127.0.0.1.7901    *.*    LISTEN
```

### 2. 深入排查

在确认基本连接后，进行了更深入的网络诊断：

1. 代理连接测试：
```bash
curl -v --proxy socks5h://127.0.0.1:7901 https://www.google.com
# 结果：连接到代理成功，但后续请求无响应
```

2. 服务器端网络测试：

本地环境结果：
```bash
# ping 测试
ping www.google.com
# 结果：100% 包丢失（预期表现）
# IP: 142.250.176.4

# HTTP 访问
curl www.google.com
# 结果：成功获得 302 重定向响应
```

服务器环境结果：
```bash
# ping 测试
ping www.google.com
# 结果：100% 包丢失
# IP: 199.16.158.8（与本地解析结果不同）

# HTTP 访问
curl www.google.com
# 结果：请求无响应，需手动中断
```

### 3. 关键发现

通过排查过程，我们发现了以下关键问题：

1. DNS 解析差异：
   - 本地和服务器解析到的 Google IP 地址不同
   - 可能存在 DNS 劫持或重定向

2. 网络限制迹象：
   - 服务器环境无法建立外部 HTTP 连接
   - 代理连接建立成功但无法传输数据

3. 容器环境限制：
   - 服务器运行在容器环境中
   - 可能存在网络策略限制
   - 可能禁用了代理或 VPN 流量

## 结论

经过详细排查，我们认为问题的根本原因在于云服务器（容器环境）的网络限制：

1. 容器可能运行在严格的网络隔离环境中
2. 可能存在防火墙规则阻止代理流量
3. 可能有特定的网络策略禁止 VPN 连接

## 建议解决方案

1. 短期解决方案：
   - 联系平台管理员了解具体的网络限制政策
   - 申请必要的网络访问权限
   - 考虑使用平台官方提供的代理服务（如果有）

## 附录：故障排查清单

1. 基础连接测试：
   - [ ] SSH 连接是否成功
   - [ ] 端口转发是否正常建立
   - [ ] 本地代理端口是否正常监听

2. 网络环境验证：
   - [ ] DNS 解析是否正常
   - [ ] 基本 HTTP 访问是否可用
   - [ ] 代理连接是否可以建立

3. 平台限制检查：
   - [ ] 容器网络策略配置
   - [ ] 防火墙规则设置
   - [ ] 出站流量限制

4. 文档与支持：
   - [ ] 查阅平台网络策略文档
   - [ ] 联系技术支持了解限制
   - [ ] 记录排查过程和发现